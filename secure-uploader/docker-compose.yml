services:
  reverse-proxy:
    image: nginx:1.27-alpine
    container_name: uploader-reverse-proxy
    restart: unless-stopped
    ports:
      - "50710:443"
    command: >-
      /bin/sh -c '
      if [ ! -f /etc/nginx/certs/selfsigned.crt ] || [ ! -f /etc/nginx/certs/selfsigned.key ]; then
        mkdir -p /etc/nginx/certs &&
        openssl req -x509 -nodes -days 825 -newkey rsa:4096
        -subj "/CN=localhost"
        -keyout /etc/nginx/certs/selfsigned.key
        -out /etc/nginx/certs/selfsigned.crt;
      fi &&
      nginx -g "daemon off;"'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - uploader
      - crowdsec
      - crowdsec-bouncer

  uploader:
    build:
      context: .
    user: "911:911"
    env_file:
      - .env
    environment:
      HTTP_PORT: 3000
      HTTPS_PORT: 3443
      UPLOAD_UID: 911
      UPLOAD_GID: 911
      OSCAR_BASE_URL: http://oscar:3000
    volumes:
      - ./data/uploads:/app/data/uploads
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      - oscar

  oscar:
    image: rogerrum/docker-oscar:latest
    container_name: oscar
    restart: unless-stopped
    expose:
      - "3000"
    volumes:
      - ./oscar-data:/config/Documents/OSCAR_Data:rw
      - ./data/uploads:/config/SDCARD:ro
    environment:
      TZ: "America/Toronto"

  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    restart: unless-stopped
    environment:
      COLLECTIONS: crowdsecurity/nginx
      GID: "1000"
    volumes:
      - ./crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      - ./nginx/logs:/var/log/nginx:ro
      - crowdsec-db:/var/lib/crowdsec/data
      - crowdsec-config:/etc/crowdsec
    expose:
      - "8080"

  crowdsec-bouncer:
    image: fbonalair/traefik-crowdsec-bouncer:latest
    container_name: crowdsec-bouncer
    restart: unless-stopped
    environment:
      CROWDSEC_BOUNCER_API_KEY: ${CROWDSEC_BOUNCER_API_KEY:?Set CROWDSEC_BOUNCER_API_KEY in .env}
      CROWDSEC_AGENT_HOST: crowdsec:8080
      GIN_MODE: release
    depends_on:
      - crowdsec
    expose:
      - "8080"

volumes:
  crowdsec-db:
  crowdsec-config:
